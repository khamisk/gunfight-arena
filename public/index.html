<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Shooter Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        #lobby-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #game-screen {
            display: none;
            width: 100%;
            height: 100vh;
            background-color: #000;
        }

        .lobby-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .lobby-container h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(135deg, #3498db, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .lobby-container p {
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.02);
                opacity: 0.9;
            }
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .input-group input {
            width: 300px;
            padding: 14px 18px;
            font-size: 1.05em;
            border: 2px solid #34495e;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            transition: all 0.3s;
            font-weight: 500;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
            transform: scale(1.02);
        }

        .color-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .color-option {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .color-option:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .color-option.selected {
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.9), 0 8px 20px rgba(0, 0, 0, 0.4);
            transform: scale(1.1);
        }

        .blue-color {
            background-color: #3498db;
        }

        .red-color {
            background-color: #e74c3c;
        }

        .yellow-color {
            background-color: #f39c12;
        }

        .green-color {
            background-color: #2ecc71;
        }

        .purple-color {
            background-color: #9b59b6;
        }

        .orange-color {
            background-color: #e67e22;
        }

        .cyan-color {
            background-color: #1abc9c;
        }

        .pink-color {
            background-color: #e91e63;
        }

        .lime-color {
            background-color: #8bc34a;
        }

        .indigo-color {
            background-color: #3f51b5;
        }

        .teal-color {
            background-color: #009688;
        }

        .magenta-color {
            background-color: #9c27b0;
        }

        .random-color {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
        }

        .button-group {
            margin-bottom: 20px;
        }

        button {
            padding: 14px 32px;
            font-size: 1.1em;
            font-weight: 600;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
        }

        .status {
            font-size: 1.2em;
            margin-top: 20px;
            min-height: 30px;
        }

        .waiting {
            color: #f39c12;
        }

        .ready {
            color: #2ecc71;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .game-ui {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            font-size: 1.2em;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(20, 20, 20, 0.75) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        #queuedPlayers {
            text-align: center;
        }

        #queuedPlayers h3 {
            color: white;
            margin-bottom: 10px;
        }

        .player-card {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 120px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .player-card.blue {
            background-color: #4a90e2;
            color: white;
        }

        .player-card.red {
            background-color: #e74c3c;
            color: white;
        }

        .player-card.yellow {
            background-color: #f39c12;
            color: #333;
        }

        .player-card.green {
            background-color: #2ecc71;
            color: white;
        }

        .player-card.purple {
            background-color: #9b59b6;
            color: white;
        }

        .player-card.orange {
            background-color: #e67e22;
            color: white;
        }

        .lobby-card {
            background: linear-gradient(135deg, rgba(52, 73, 94, 0.95) 0%, rgba(44, 62, 80, 0.95) 100%);
            border: 2px solid #34495e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .lobby-card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2) 0%, rgba(52, 73, 94, 0.95) 100%);
        }

        .lobby-card.locked {
            border-color: #f39c12;
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.15) 0%, rgba(52, 73, 94, 0.95) 100%);
        }

        .lobby-card.locked:hover {
            border-color: #f1c40f;
            box-shadow: 0 8px 20px rgba(241, 196, 15, 0.3);
        }

        .lobby-card h3 {
            margin: 0 0 12px 0;
            font-size: 1.4em;
            font-weight: 700;
            color: #3498db;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .lobby-card.locked h3 {
            color: #f39c12;
        }

        .lobby-card p {
            margin: 8px 0;
            color: #ecf0f1;
            font-size: 1em;
            font-weight: 500;
        }

        .player-score {
            font-size: 0.8em;
            margin-top: 5px;
            opacity: 0.9;
        }

        .player-info {
            margin-bottom: 10px;
        }

        .health-bar {
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #fff;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.1s;
        }

        #powerupTimer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 26px;
            font-weight: 800;
            display: none;
            border: 4px solid;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.7), inset 0 0 20px rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #powerupTimer.machinegun {
            border-color: #2ecc71;
            color: #2ecc71;
        }

        #powerupTimer.ricochet {
            border-color: #e91e63;
            color: #e91e63;
        }

        #powerupTimer.speed {
            border-color: #00ffff;
            color: #00ffff;
        }

        #powerupTimer.noclip {
            border-color: #ffffff;
            color: #ffffff;
        }

        #powerupTimer.cannon {
            border-color: #ff6600;
            color: #ff6600;
        }

        #powerupTimer.gravity {
            border-color: #9900ff;
            color: #9900ff;
        }

        #powerupTimer.railgun {
            border-color: #ff0000;
            color: #ff0000;
        }

        #powerupTimer.blink {
            border-color: #00ccff;
            color: #00ccff;
        }

        #powerupTimer.bouncyball {
            border-color: #ffff00;
            color: #ffff00;
        }
    </style>
</head>

<body>
    <!-- Main Menu / Lobby Browser -->
    <div id="main-menu">
        <div class="lobby-container">
            <h1>üéÆ GUNFIGHT ARENA</h1>
            <p style="font-size: 1.2em; color: #3498db; margin: 10px 0;">Up to 6 Players ‚Ä¢ Battle Royale ‚Ä¢ Last One
                Standing</p>

            <div class="input-group">
                <label for="playerName">Your Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
            </div>

            <div class="button-group">
                <button id="createLobbyBtn" style="background: #2ecc71;">Create Lobby</button>
                <button id="refreshLobbiesBtn" style="background: #3498db;">Refresh Lobbies</button>
            </div>

            <div style="margin-top: 30px;">
                <h2 style="font-size: 1.5em; margin-bottom: 15px;">Available Lobbies</h2>
                <div id="lobbiesList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Lobby Room (Waiting for players) -->
    <div id="lobby-room" style="display: none;">
        <div class="lobby-container">
            <h1 id="lobbyRoomTitle">üéÆ Lobby</h1>
            <p id="lobbyRoomInfo" style="font-size: 1.1em; color: #95a5a6;"></p>

            <div id="colorSelectorContainer" class="input-group">
                <label>Select Color:</label>
                <div class="color-selector"
                    style="display: grid; grid-template-columns: repeat(6, 50px); gap: 10px; justify-content: center;">
                    <div class="color-option lobby-color-option blue-color" data-color="blue"></div>
                    <div class="color-option lobby-color-option red-color" data-color="red"></div>
                    <div class="color-option lobby-color-option yellow-color" data-color="yellow"></div>
                    <div class="color-option lobby-color-option green-color" data-color="green"></div>
                    <div class="color-option lobby-color-option purple-color" data-color="purple"></div>
                    <div class="color-option lobby-color-option orange-color" data-color="orange"></div>
                    <div class="color-option lobby-color-option cyan-color" data-color="cyan"></div>
                    <div class="color-option lobby-color-option pink-color" data-color="pink"></div>
                    <div class="color-option lobby-color-option lime-color" data-color="lime"></div>
                    <div class="color-option lobby-color-option indigo-color" data-color="indigo"></div>
                    <div class="color-option lobby-color-option teal-color" data-color="teal"></div>
                    <div class="color-option lobby-color-option magenta-color" data-color="magenta"></div>
                    <div class="color-option lobby-color-option random-color" data-color="random" title="Random Color"
                        style="position: relative;">
                        <span
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px;">üé≤</span>
                    </div>
                </div>
            </div>

            <div id="queuedPlayers" style="margin-top: 20px; min-height: 200px;">
                <h3 style="font-size: 1.2em; margin-bottom: 10px;">Players (<span id="playerCount">0</span>/6):</h3>
                <div id="queuedPlayersList"></div>
            </div>

            <div class="button-group" style="margin-top: 20px;">
                <button id="startGameBtn" style="display: none; background: #2ecc71;">Start Game</button>
                <button id="leaveLobbyBtn" style="background: #e74c3c;">Leave Lobby</button>
            </div>

            <div class="status" id="status">Waiting for players...</div>
        </div>
    </div>

    <!-- Create Lobby Modal -->
    <div id="createLobbyModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #2c3e50; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
            <h2 style="margin-top: 0;">Create New Lobby</h2>
            <div class="input-group">
                <label for="lobbyNameInput">Lobby Name:</label>
                <input type="text" id="lobbyNameInput" placeholder="My Awesome Lobby" maxlength="30">
            </div>
            <div class="input-group">
                <label for="lobbyPasswordInput">Password (Optional):</label>
                <input type="password" id="lobbyPasswordInput" placeholder="Leave empty for public" maxlength="20">
            </div>
            <div class="button-group">
                <button id="confirmCreateLobbyBtn" style="background: #2ecc71;">Create</button>
                <button id="cancelCreateLobbyBtn" style="background: #95a5a6;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Join Lobby Modal -->
    <div id="joinLobbyModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #2c3e50; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
            <h2 style="margin-top: 0;" id="joinLobbyTitle">Join Lobby</h2>
            <div class="input-group" id="joinPasswordGroup" style="display: none;">
                <label for="joinPasswordInput">Password:</label>
                <input type="password" id="joinPasswordInput" placeholder="Enter password" maxlength="20">
            </div>
            <div class="button-group">
                <button id="confirmJoinLobbyBtn" style="background: #2ecc71;">Join</button>
                <button id="cancelJoinLobbyBtn" style="background: #95a5a6;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="game-screen">
        <canvas id="gameCanvas"></canvas>
        <div id="powerupTimer"></div>
        <div class="game-ui">
            <div id="playersList"></div>
        </div>
        <div id="chatInputContainer"
            style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px;">
            <input type="text" id="chatInput" placeholder="Type message... (Press Enter to send, Esc to cancel)"
                maxlength="100"
                style="width: 400px; padding: 8px; border: 2px solid #3498db; border-radius: 3px; font-size: 14px;">
        </div>
        <div id="emojiWheel"
            style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); padding: 20px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3);">
            <div
                style="text-align: center; color: white; font-size: 50px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div class="emoji-option" data-emoji="happy" style="cursor: pointer; transition: transform 0.2s;">üòä
                </div>
                <div class="emoji-option" data-emoji="sad" style="cursor: pointer; transition: transform 0.2s;">üò¢</div>
                <div class="emoji-option" data-emoji="angry" style="cursor: pointer; transition: transform 0.2s;">üò†
                </div>
                <div class="emoji-option" data-emoji="laugh" style="cursor: pointer; transition: transform 0.2s;">üòÇ
                </div>
                <div class="emoji-option" data-emoji="cool" style="cursor: pointer; transition: transform 0.2s;">üòé
                </div>
                <div class="emoji-option" data-emoji="love" style="cursor: pointer; transition: transform 0.2s;">üòç
                </div>
            </div>
        </div>
        <div id="adminPanel"
            style="display: none; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; border: 2px solid #f39c12; max-width: 250px;">
            <h3 style="margin: 0 0 15px 0; color: #f39c12; font-size: 18px;">‚ö° Admin Panel</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="admin-powerup-btn" data-powerup="machinegun"
                    style="padding: 8px; background: #2ecc71; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">MG</button>
                <button class="admin-powerup-btn" data-powerup="ricochet"
                    style="padding: 8px; background: #9b59b6; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Ricochet</button>
                <button class="admin-powerup-btn" data-powerup="speed"
                    style="padding: 8px; background: #3498db; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Speed</button>
                <button class="admin-powerup-btn" data-powerup="noclip"
                    style="padding: 8px; background: #95a5a6; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">NoClip</button>
                <button class="admin-powerup-btn" data-powerup="cannon"
                    style="padding: 8px; background: #e67e22; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Cannon</button>
                <button class="admin-powerup-btn" data-powerup="gravity"
                    style="padding: 8px; background: #8e44ad; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Gravity</button>
                <button class="admin-powerup-btn" data-powerup="railgun"
                    style="padding: 8px; background: #e74c3c; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Railgun</button>
                <button class="admin-powerup-btn" data-powerup="blink"
                    style="padding: 8px; background: #1abc9c; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Blink</button>
                <button class="admin-powerup-btn" data-powerup="bouncyball"
                    style="padding: 8px; background: #f1c40f; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; grid-column: span 2;">Bouncy
                    Ball</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameScreen = document.getElementById('game-screen');
        const powerupTimerDiv = document.getElementById('powerupTimer');

        let selectedColor = 'blue';
        let ws = null;
        let gameState = null;
        let playerId = null;
        let playerColor = null;
        let keys = {};
        let mouseAngle = 0;
        let joinTime = null;
        let countdownInterval = null;
        let lastPlayerCount = 0;
        let currentLobbyId = null;
        let isHost = false;
        let pendingLobbyJoin = null; // {lobbyId, hasPassword}
        let playerName = '';
        let localKills = parseInt(localStorage.getItem('totalKills') || '0');

        // Extended color palette
        const ALL_COLORS = ['blue', 'red', 'yellow', 'green', 'purple', 'orange', 'cyan', 'pink', 'lime', 'indigo', 'teal', 'magenta'];

        // Update player name from input
        const playerNameInput = document.getElementById('playerName');
        playerName = localStorage.getItem('playerName') || '';
        if (playerName) {
            playerNameInput.value = playerName;
        }
        playerNameInput.addEventListener('input', (e) => {
            playerName = e.target.value.trim();
            if (playerName) {
                localStorage.setItem('playerName', playerName);
            }
        });

        function showScreen(screenName) {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('lobby-room').style.display = 'none';
            gameScreen.style.display = 'none';
            document.getElementById(screenName).style.display = 'block';
        }

        function renderLobbiesList(lobbies) {
            const container = document.getElementById('lobbiesList');
            container.innerHTML = '';

            if (lobbies.length === 0) {
                container.innerHTML = '<div style="color: #999; padding: 40px; text-align: center;">No lobbies available. Create one!</div>';
                return;
            }

            lobbies.forEach(lobby => {
                const card = document.createElement('div');
                card.className = `lobby-card ${lobby.hasPassword ? 'locked' : ''}`;
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="margin: 0;">${lobby.name}</h3>
                        ${lobby.hasPassword ? '<span style="font-size: 20px;">üîí</span>' : ''}
                    </div>
                    <div style="color: #aaa;">Host: ${lobby.hostName}</div>
                    <div style="color: #aaa;">Players: ${lobby.playerCount}/${lobby.maxPlayers}</div>
                `;
                card.onclick = () => {
                    if (!playerName) {
                        alert('Please enter your name first!');
                        playerNameInput.focus();
                        return;
                    }
                    pendingLobbyJoin = { lobbyId: lobby.id, hasPassword: lobby.hasPassword };
                    if (lobby.hasPassword) {
                        document.getElementById('joinPasswordGroup').style.display = 'block';
                    } else {
                        document.getElementById('joinPasswordGroup').style.display = 'none';
                    }
                    document.getElementById('joinLobbyTitle').textContent = `Join ${lobby.name}`;
                    document.getElementById('joinLobbyModal').style.display = 'flex';
                };
                container.appendChild(card);
            });
        }

        function updateLobbyRoom(lobby, isHostPlayer) {
            console.log('üìä Updating lobby room. isHost:', isHostPlayer);
            isHost = isHostPlayer;
            const playersList = document.getElementById('queuedPlayersList');
            const playerCountSpan = document.getElementById('playerCount');
            playersList.innerHTML = '';
            playerCountSpan.textContent = lobby.players.length;

            lobby.players.forEach(player => {
                // Update our player color if it changed (match by name)
                if (player.name === playerName) {
                    playerColor = player.color;
                    playerId = player.id; // Update our playerId to match server
                }

                const playerDiv = document.createElement('div');
                playerDiv.className = 'lobby-player-item';
                playerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; margin: 8px 0; background: #333; border-radius: 5px;';

                const playerInfo = document.createElement('div');
                playerInfo.style.cssText = 'display: flex; align-items: center; gap: 15px; flex: 1;';

                // Show local kills if it's the current player
                const kills = player.id === playerId ? localKills : (player.kills || 0);
                const wins = player.wins || 0;

                playerInfo.innerHTML = `
                    <div style="width: 25px; height: 25px; border-radius: 50%; background: ${player.color}; border: 2px solid #555;"></div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1.1em;">${player.name}${player.id === lobby.hostId ? ' üëë' : ''}</div>
                        <div style="font-size: 0.85em; color: #aaa; margin-top: 2px;">
                            üèÜ ${wins} Wins ‚Ä¢ üíÄ ${kills} Kills
                        </div>
                    </div>
                `;

                playerDiv.appendChild(playerInfo);

                if (isHost && player.id !== lobby.hostId) {
                    const kickBtn = document.createElement('button');
                    kickBtn.textContent = 'Kick';
                    kickBtn.style.cssText = 'padding: 5px 10px; background: #d9534f; color: white; border: none; border-radius: 3px; cursor: pointer;';
                    kickBtn.onclick = () => {
                        ws.send(JSON.stringify({
                            type: 'kick_player',
                            playerId: player.id
                        }));
                    };
                    playerDiv.appendChild(kickBtn);
                }

                playersList.appendChild(playerDiv);
            });

            // Update lobby title
            document.getElementById('lobbyRoomTitle').textContent = lobby.name;

            // Update start button visibility
            const startBtn = document.getElementById('startGameBtn');
            if (startBtn) {
                startBtn.style.display = isHost ? 'inline-block' : 'none';
                console.log('üéÆ Start button display:', startBtn.style.display, 'isHost:', isHost);
            }

            // Update color selector to highlight current color
            document.querySelectorAll('.lobby-color-option').forEach(option => {
                const optionColor = option.dataset.color;
                if (optionColor === 'random') {
                    option.style.opacity = '1';
                    option.style.cursor = 'pointer';
                    option.style.border = '2px solid #555';
                    return;
                }
                const isUsed = lobby.players.some(p => p.color === optionColor && p.id !== playerId);
                const isCurrent = playerColor === optionColor;

                option.style.opacity = isUsed ? '0.3' : '1';
                option.style.cursor = isUsed ? 'not-allowed' : 'pointer';
                option.style.border = isCurrent ? '3px solid white' : '2px solid #555';
            });
        } function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedColor = option.dataset.color;
            });
        });

        // Emoji wheel click handlers
        document.querySelectorAll('.emoji-option').forEach(option => {
            option.addEventListener('click', () => {
                const emoji = option.dataset.emoji;
                if (ws && gameState) {
                    ws.send(JSON.stringify({
                        type: 'emoji',
                        emoji: emoji
                    }));
                    emojiWheelOpen = false;
                    emojiWheel.style.display = 'none';
                }
            });

            // Hover effect
            option.addEventListener('mouseenter', () => {
                option.style.transform = 'scale(1.2)';
            });
            option.addEventListener('mouseleave', () => {
                option.style.transform = 'scale(1)';
            });
        });

        // Admin powerup buttons
        document.querySelectorAll('.admin-powerup-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const powerup = btn.dataset.powerup;
                if (ws && gameState && adminAuthenticated) {
                    ws.send(JSON.stringify({
                        type: 'admin_powerup',
                        powerup: powerup
                    }));
                }
            });
        });

        // Main menu buttons
        document.getElementById('createLobbyBtn').addEventListener('click', () => {
            if (!playerName) {
                alert('Please enter your name first!');
                playerNameInput.focus();
                return;
            }
            document.getElementById('createLobbyModal').style.display = 'flex';
        });

        document.getElementById('refreshLobbiesBtn').addEventListener('click', () => {
            if (ws) {
                ws.send(JSON.stringify({ type: 'get_lobbies' }));
            }
        });

        document.getElementById('cancelCreateLobbyBtn').addEventListener('click', () => {
            document.getElementById('createLobbyModal').style.display = 'none';
        });

        document.getElementById('confirmCreateLobbyBtn').addEventListener('click', () => {
            const lobbyName = document.getElementById('lobbyNameInput').value.trim();
            const lobbyPassword = document.getElementById('lobbyPasswordInput').value;

            if (!lobbyName) {
                alert('Lobby name is required!');
                return;
            }

            if (ws) {
                playerColor = selectedColor;
                ws.send(JSON.stringify({
                    type: 'create_lobby',
                    name: lobbyName,
                    password: lobbyPassword,
                    playerName: playerName,
                    color: selectedColor
                }));
                document.getElementById('createLobbyModal').style.display = 'none';
                document.getElementById('lobbyNameInput').value = '';
                document.getElementById('lobbyPasswordInput').value = '';
            }
        });

        // Join lobby modal buttons
        document.getElementById('cancelJoinLobbyBtn').addEventListener('click', () => {
            document.getElementById('joinLobbyModal').style.display = 'none';
            document.getElementById('joinPasswordInput').value = '';
            pendingLobbyJoin = null;
        });

        document.getElementById('confirmJoinLobbyBtn').addEventListener('click', () => {
            if (!pendingLobbyJoin || !ws) return;

            const password = pendingLobbyJoin.hasPassword ? document.getElementById('joinPasswordInput').value : '';

            if (pendingLobbyJoin.hasPassword && !password) {
                alert('Password is required!');
                return;
            }

            playerColor = selectedColor;
            ws.send(JSON.stringify({
                type: 'join_lobby',
                lobbyId: pendingLobbyJoin.lobbyId,
                name: playerName,
                password: password
            }));

            document.getElementById('joinLobbyModal').style.display = 'none';
            document.getElementById('joinPasswordInput').value = '';
            pendingLobbyJoin = null;
        });

        // Lobby room buttons
        document.getElementById('leaveLobbyBtn').addEventListener('click', () => {
            if (ws) {
                ws.send(JSON.stringify({ type: 'leave_lobby' }));
                showScreen('main-menu');
                ws.send(JSON.stringify({ type: 'get_lobbies' }));
            }
        });

        document.getElementById('startGameBtn').addEventListener('click', () => {
            console.log('üéÆ Start button clicked! ws:', !!ws, 'isHost:', isHost);
            if (ws && isHost) {
                console.log('üì§ Sending start_game message');
                ws.send(JSON.stringify({ type: 'start_game' }));
            } else {
                console.log('‚ùå Cannot start game - ws:', !!ws, 'isHost:', isHost);
            }
        });

        // Color selector in lobby
        document.querySelectorAll('.lobby-color-option').forEach(option => {
            option.addEventListener('click', () => {
                let color = option.dataset.color;

                // Handle random color
                if (color === 'random') {
                    // Pick a random color from available colors
                    const availableColors = ALL_COLORS.filter(c => {
                        // Get current lobby to check which colors are taken
                        return true; // Server will handle availability
                    });
                    color = availableColors[Math.floor(Math.random() * availableColors.length)];
                }

                if (ws && currentLobbyId) {
                    ws.send(JSON.stringify({
                        type: 'change_color',
                        color: color
                    }));
                }
            });
        });

        // Initialize connection on page load
        initializeConnection();

        let railgunCharging = false;
        let chatOpen = false;
        let emojiWheelOpen = false;
        let adminAuthenticated = false;

        const chatInputContainer = document.getElementById('chatInputContainer');
        const chatInput = document.getElementById('chatInput');
        const emojiWheel = document.getElementById('emojiWheel');
        const adminPanel = document.getElementById('adminPanel');

        window.addEventListener('keydown', (e) => {
            // Chat input handling
            if (chatOpen) {
                if (e.key === 'Enter') {
                    const message = chatInput.value.trim();
                    if (message && ws) {
                        ws.send(JSON.stringify({
                            type: 'chat',
                            message: message
                        }));
                    }
                    chatInput.value = '';
                    chatInputContainer.style.display = 'none';
                    chatOpen = false;
                    return;
                } else if (e.key === 'Escape') {
                    chatInput.value = '';
                    chatInputContainer.style.display = 'none';
                    chatOpen = false;
                    return;
                }
                return; // Don't process other keys while chat is open
            }

            // Open chat with Enter
            if (e.key === 'Enter' && ws && gameState && !chatOpen) {
                e.preventDefault();
                chatOpen = true;
                chatInputContainer.style.display = 'block';
                chatInput.focus();
                return;
            }

            // Show emoji wheel with B
            if (e.key.toLowerCase() === 'b' && ws && gameState && !emojiWheelOpen) {
                e.preventDefault();
                emojiWheelOpen = true;
                emojiWheel.style.display = 'block';
                return;
            }

            // Admin panel with P
            if (e.key.toLowerCase() === 'p' && ws && gameState) {
                e.preventDefault();

                if (!adminAuthenticated) {
                    const password = prompt('Enter admin password:');
                    if (password === 'admin1') {
                        adminAuthenticated = true;
                        adminPanel.style.display = 'block';
                    }
                } else {
                    // Toggle panel
                    adminPanel.style.display = adminPanel.style.display === 'none' ? 'block' : 'none';
                }
                return;
            }

            keys[e.key.toLowerCase()] = true;

            // Railgun charging (hold mouse)
            if (e.button === undefined && isMouseDown && ws && gameState) {
                const ourPlayer = Object.values(gameState.players).find(p => p.color === playerColor);
                if (ourPlayer && ourPlayer.powerup === 'railgun' && !railgunCharging) {
                    railgunCharging = true;
                    ws.send(JSON.stringify({
                        type: 'railgun_charge_start'
                    }));
                }
            }

            // Blink dash with spacebar (only if chat not open)
            if (e.key === ' ' && ws && gameState && !chatOpen) {
                e.preventDefault(); // Prevent page scroll
                const ourPlayer = Object.values(gameState.players).find(p => p.color === playerColor);
                if (ourPlayer && ourPlayer.powerup === 'blink') {
                    ws.send(JSON.stringify({
                        type: 'blink_dash',
                        angle: mouseAngle
                    }));
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            // Hide emoji wheel when B is released
            if (e.key.toLowerCase() === 'b' && emojiWheelOpen) {
                emojiWheelOpen = false;
                emojiWheel.style.display = 'none';
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        window.addEventListener('mousemove', (e) => {
            if (!gameState) return;

            // Find our player first
            const ourPlayer = Object.values(gameState.players).find(p => p.color === playerColor);
            if (!ourPlayer) return;

            // Get canvas position and size
            const rect = canvas.getBoundingClientRect();

            // Mouse position relative to canvas (in pixels on screen)
            const mouseScreenX = e.clientX - rect.left;
            const mouseScreenY = e.clientY - rect.top;

            // Convert to game world coordinates (800x600 game world)
            const gameMouseX = (mouseScreenX / rect.width) * 800;
            const gameMouseY = (mouseScreenY / rect.height) * 600;

            // Calculate angle from player position (in game world) to mouse position (in game world)
            const dx = gameMouseX - ourPlayer.x;
            const dy = gameMouseY - ourPlayer.y;

            // Only update if we have a valid angle (not at exact same position)
            if (dx !== 0 || dy !== 0) {
                mouseAngle = Math.atan2(dy, dx);
            }
        });

        let isMouseDown = false;

        // Mousedown for shooting and railgun charging
        canvas.addEventListener('mousedown', (e) => {
            isMouseDown = true;

            if (!ws || !gameState) return;

            const ourPlayer = Object.values(gameState.players).find(p => p.color === playerColor);
            if (!ourPlayer) return;

            // Railgun: hold to charge
            if (ourPlayer.powerup === 'railgun') {
                if (!railgunCharging) {
                    railgunCharging = true;
                    ws.send(JSON.stringify({
                        type: 'railgun_charge_start'
                    }));
                }
                return;
            }

            // Normal shooting - single click
            ws.send(JSON.stringify({
                type: 'shoot',
                angle: mouseAngle
            }));
        });

        // Mouseup to fire railgun and stop continuous fire
        window.addEventListener('mouseup', () => {
            isMouseDown = false;

            if (!ws || !gameState) return;

            const ourPlayer = Object.values(gameState.players).find(p => p.color === playerColor);
            if (!ourPlayer) return;

            // Fire railgun on release if charged
            if (ourPlayer.powerup === 'railgun' && railgunCharging && ourPlayer.railgunCharging) {
                const chargeTime = gameState.gameTime - ourPlayer.railgunChargeStart;
                if (chargeTime >= 2) {
                    railgunCharging = false;
                    ws.send(JSON.stringify({
                        type: 'railgun_fire',
                        angle: mouseAngle
                    }));
                } else {
                    // Not charged enough - cancel
                    railgunCharging = false;
                    ws.send(JSON.stringify({
                        type: 'railgun_charge_cancel'
                    }));
                }
            }
        });

        function initializeConnection() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected!');
                playerId = Math.random().toString(36).substr(2, 9);

                // Request lobbies list
                ws.send(JSON.stringify({ type: 'get_lobbies' }));
                console.log('üì§ Requested lobbies list');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('üì® Received:', data.type);

                if (data.type === 'lobbies_list') {
                    renderLobbiesList(data.lobbies);
                }

                if (data.type === 'lobby_joined') {
                    currentLobbyId = data.lobbyId;
                    showScreen('lobby-room');
                }

                if (data.type === 'lobby_update') {
                    updateLobbyRoom(data.lobby, data.isHost);
                }

                if (data.type === 'kicked') {
                    alert('You were kicked from the lobby!');
                    showScreen('main-menu');
                    ws.send(JSON.stringify({ type: 'get_lobbies' }));
                }

                if (data.type === 'error') {
                    alert(data.message);
                }

                if (data.type === 'game_state') {
                    console.log('üéÆ GAME STATE RECEIVED! Switching to game screen...');

                    // Store game state
                    gameState = data.state;
                    console.log('Players in game:', Object.keys(data.state.players).length);

                    // Force screen switch
                    document.getElementById('main-menu').style.display = 'none';
                    document.getElementById('lobby-room').style.display = 'none';
                    gameScreen.style.display = 'block';
                    console.log('‚úÖ Game screen visible!');

                    // Start rendering
                    render();
                }

                if (data.type === 'game_end') {
                    console.log('üèÅ Game ended! Returning to lobby...');

                    // Update local kills if we got any
                    if (data.finalStats && data.finalStats.length > 0) {
                        console.log('Final scores:', data.finalStats);
                        const ourStats = data.finalStats.find(s => s.name === playerName);
                        if (ourStats && ourStats.kills > 0) {
                            localKills += ourStats.kills;
                            localStorage.setItem('totalKills', localKills.toString());
                            console.log(`Updated local kills: ${localKills}`);
                        }
                    }

                    // Return to lobby after 3 seconds
                    setTimeout(() => {
                        gameScreen.style.display = 'none';
                        gameState = null;
                        if (currentLobbyId) {
                            showScreen('lobby-room');
                            // Request updated lobby state
                            ws.send(JSON.stringify({ type: 'get_lobby_state', lobbyId: currentLobbyId }));
                        } else {
                            showScreen('main-menu');
                            ws.send(JSON.stringify({ type: 'get_lobbies' }));
                        }
                        console.log('‚úÖ Back to lobby!');
                    }, 3000);
                }
            };

            ws.onerror = () => {
                alert('Connection error. Please refresh the page.');
            };

            ws.onclose = () => {
                gameScreen.style.display = 'none';
                showScreen('main-menu');
                gameState = null;
                alert('Disconnected from server. Please refresh the page.');
            };
        }

        let lastSentAngle = 0;
        let lastSentVx = 0;
        let lastSentVy = 0;
        let lastUpdateTime = 0;

        function updateMovement() {
            if (!ws || !gameState) return;

            let vx = 0;
            let vy = 0;

            if (keys['w'] || keys['arrowup']) vy -= 1;
            if (keys['s'] || keys['arrowdown']) vy += 1;
            if (keys['a'] || keys['arrowleft']) vx -= 1;
            if (keys['d'] || keys['arrowright']) vx += 1;

            if (vx !== 0 || vy !== 0) {
                const magnitude = Math.sqrt(vx * vx + vy * vy);
                vx /= magnitude;
                vy /= magnitude;
            }

            // Always send movement and angle updates
            ws.send(JSON.stringify({
                type: 'move',
                vx: vx,
                vy: vy,
                angle: mouseAngle
            }));
        }

        function render() {
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!gameState) return;

            // Update powerup timer for our player
            const ourPlayer = Object.values(gameState.players).find(p => p.color === playerColor);
            if (ourPlayer && ourPlayer.powerup && ourPlayer.powerupTime !== undefined && gameState.gameTime !== undefined) {
                const elapsed = gameState.gameTime - ourPlayer.powerupTime;
                const remaining = Math.max(0, 5 - elapsed);

                if (remaining > 0) {
                    powerupTimerDiv.style.display = 'block';
                    powerupTimerDiv.className = ourPlayer.powerup;

                    let powerupName;
                    switch (ourPlayer.powerup) {
                        case 'machinegun': powerupName = 'MACHINE GUN'; break;
                        case 'ricochet': powerupName = 'RICOCHET GUN'; break;
                        case 'speed': powerupName = 'SPEED BOOST'; break;
                        case 'noclip': powerupName = 'NO CLIP'; break;
                        case 'cannon': powerupName = 'CANNON'; break;
                        case 'gravity': powerupName = 'GRAVITY WELL'; break;
                        case 'railgun': powerupName = 'RAILGUN'; break;
                        case 'blink': powerupName = 'BLINK DASH'; break;
                        case 'bouncyball': powerupName = 'BOUNCY BALL'; break;
                        default: powerupName = ourPlayer.powerup.toUpperCase();
                    }

                    powerupTimerDiv.textContent = `${powerupName}: ${remaining.toFixed(1)}s`;
                } else {
                    powerupTimerDiv.style.display = 'none';
                }
            } else {
                powerupTimerDiv.style.display = 'none';
            }

            const scaleX = canvas.width / 800;
            const scaleY = canvas.height / 600;

            // Draw zone (red overlay outside safe zone)
            if (gameState.zone && gameState.zone.active) {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';

                // Top area
                ctx.fillRect(0, 0, canvas.width, gameState.zone.y * scaleY);
                // Bottom area
                ctx.fillRect(0, (gameState.zone.y + gameState.zone.height) * scaleY, canvas.width, canvas.height);
                // Left area
                ctx.fillRect(0, gameState.zone.y * scaleY, gameState.zone.x * scaleX, gameState.zone.height * scaleY);
                // Right area
                ctx.fillRect((gameState.zone.x + gameState.zone.width) * scaleX, gameState.zone.y * scaleY, canvas.width, gameState.zone.height * scaleY);

                // Draw zone border
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.strokeRect(gameState.zone.x * scaleX, gameState.zone.y * scaleY, gameState.zone.width * scaleX, gameState.zone.height * scaleY);
            }

            ctx.fillStyle = '#444';
            gameState.walls.forEach(wall => {
                ctx.fillRect(wall.x * scaleX, wall.y * scaleY, wall.width * scaleX, wall.height * scaleY);
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 2;
                ctx.strokeRect(wall.x * scaleX, wall.y * scaleY, wall.width * scaleX, wall.height * scaleY);
            });

            // Draw powerups
            if (gameState.powerups) {
                gameState.powerups.forEach(powerup => {
                    // Pulsing effect
                    const pulse = Math.sin(Date.now() / 200) * 2 + 15;

                    // Color and label based on powerup type
                    let color, label;
                    switch (powerup.type) {
                        case 'machinegun':
                            color = '#00ff00'; // Green
                            label = 'MG';
                            break;
                        case 'ricochet':
                            color = '#ff00ff'; // Magenta
                            label = 'RC';
                            break;
                        case 'speed':
                            color = '#00ffff'; // Cyan
                            label = 'SPD';
                            break;
                        case 'noclip':
                            color = '#ffffff'; // White
                            label = 'NC';
                            break;
                        case 'cannon':
                            color = '#ff6600'; // Orange
                            label = 'CAN';
                            break;
                        case 'gravity':
                            color = '#9900ff'; // Purple
                            label = 'GRAV';
                            break;
                        case 'railgun':
                            color = '#ff0000'; // Red
                            label = 'RAIL';
                            break;
                        case 'blink':
                            color = '#00ccff'; // Light blue
                            label = 'BLNK';
                            break;
                        case 'bouncyball':
                            color = '#ffff00'; // Yellow
                            label = 'BNCY';
                            break;
                        default:
                            color = '#ffffff';
                            label = '?';
                    }

                    ctx.fillStyle = color;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = color;

                    ctx.beginPath();
                    ctx.arc(powerup.x * scaleX, powerup.y * scaleY, pulse, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;

                    // Label
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.strokeText(label, powerup.x * scaleX, powerup.y * scaleY + 25);
                    ctx.fillText(label, powerup.x * scaleX, powerup.y * scaleY + 25);
                });
            }

            gameState.bullets.forEach(bullet => {
                // Different colors and sizes for different bullet types
                const isRailgun = bullet.railgun;
                const isCannon = bullet.throughWalls && !isRailgun;
                const isBouncyBall = bullet.size >= 40;
                const bulletSize = bullet.size || 5;

                if (isRailgun) {
                    // Draw railgun beam as thick line
                    const length = 30; // Beam trail length
                    const angle = Math.atan2(bullet.vy, bullet.vx);
                    const startX = bullet.x - Math.cos(angle) * length;
                    const startY = bullet.y - Math.sin(angle) * length;

                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 8;
                    ctx.shadowBlur = 30;
                    ctx.shadowColor = '#ff0000';

                    ctx.beginPath();
                    ctx.moveTo(startX * scaleX, startY * scaleY);
                    ctx.lineTo(bullet.x * scaleX, bullet.y * scaleY);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                } else if (isBouncyBall) {
                    ctx.shadowBlur = 30;
                    ctx.shadowColor = '#ffff00';
                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(bullet.x * scaleX, bullet.y * scaleY, bulletSize, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                } else if (isCannon) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#ff6600';
                    ctx.fillStyle = '#ff6600';
                    ctx.beginPath();
                    ctx.arc(bullet.x * scaleX, bullet.y * scaleY, bulletSize, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                } else {
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#ffff00';
                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(bullet.x * scaleX, bullet.y * scaleY, bulletSize, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });

            // Draw railgun laser
            if (gameState.railgunLaser) {
                const laser = gameState.railgunLaser;
                const endX = laser.startX + Math.cos(laser.angle) * laser.length;
                const endY = laser.startY + Math.sin(laser.angle) * laser.length;

                // Bright red laser beam
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 4;
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#ff0000';

                ctx.beginPath();
                ctx.moveTo(laser.startX * scaleX, laser.startY * scaleY);
                ctx.lineTo(endX * scaleX, endY * scaleY);
                ctx.stroke();

                ctx.shadowBlur = 0;
            }

            Object.values(gameState.players).forEach(player => {
                if (player.health <= 0) {
                    // Dead player - show as gray
                    ctx.fillStyle = '#666';
                    ctx.globalAlpha = 0.5;
                } else {
                    ctx.fillStyle = player.color;
                    ctx.globalAlpha = 1.0;
                }

                ctx.beginPath();
                ctx.arc(player.x * scaleX, player.y * scaleY, 10, 0, Math.PI * 2); // 10 pixel radius for better visibility
                ctx.fill();

                if (player.health > 0) {
                    // Draw gun direction
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3;
                    ctx.globalAlpha = 1.0;
                    ctx.beginPath();
                    ctx.moveTo(player.x * scaleX, player.y * scaleY);
                    ctx.lineTo(
                        (player.x + Math.cos(player.angle) * 15) * scaleX,
                        (player.y + Math.sin(player.angle) * 15) * scaleY
                    );
                    ctx.stroke();
                }

                // Chat message above player
                if (player.chatMessage) {
                    ctx.save();
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.font = 'bold 12px Arial';
                    const messageWidth = ctx.measureText(player.chatMessage).width;
                    const padding = 8;
                    const bubbleX = player.x * scaleX - (messageWidth + padding * 2) / 2;
                    const bubbleY = (player.y - 55) * scaleY;

                    // Speech bubble background
                    ctx.fillRect(bubbleX, bubbleY, messageWidth + padding * 2, 20);

                    // Speech bubble tail (small triangle)
                    ctx.beginPath();
                    ctx.moveTo(player.x * scaleX - 5, bubbleY + 20);
                    ctx.lineTo(player.x * scaleX + 5, bubbleY + 20);
                    ctx.lineTo(player.x * scaleX, bubbleY + 25);
                    ctx.closePath();
                    ctx.fill();

                    // Message text
                    ctx.fillStyle = '#fff';
                    ctx.fillText(player.chatMessage, player.x * scaleX, bubbleY + 14);
                    ctx.restore();
                }

                // Emoji above player
                if (player.emoji) {
                    const emojiMap = {
                        'happy': 'üòä', 'sad': 'üò¢', 'angry': 'üò†',
                        'laugh': 'üòÇ', 'cool': 'üòé', 'love': 'üòç'
                    };
                    ctx.font = '30px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(emojiMap[player.emoji] || 'üòä', player.x * scaleX, (player.y - 50) * scaleY);
                }

                // Player name
                ctx.fillStyle = '#fff';
                ctx.globalAlpha = 1.0;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.strokeText(player.name, player.x * scaleX, (player.y + 32) * scaleY);
                ctx.fillText(player.name, player.x * scaleX, (player.y + 32) * scaleY);

                // Health bar background
                ctx.fillStyle = '#333';
                ctx.fillRect((player.x - 15) * scaleX, (player.y - 30) * scaleY, 30 * scaleX, 5 * scaleY);

                // Health bar fill
                const healthPercent = Math.max(0, player.health) / 100;
                ctx.fillStyle = player.health > 50 ? '#2ecc71' : player.health > 25 ? '#f39c12' : '#e74c3c';
                ctx.fillRect((player.x - 15) * scaleX, (player.y - 30) * scaleY, 30 * healthPercent * scaleX, 5 * scaleY);

                // Railgun charging indicator and beam preview
                if (player.railgunCharging) {
                    const chargeTime = gameState.gameTime - player.railgunChargeStart;
                    const chargePercent = Math.min(chargeTime / 2, 1); // 2 seconds to full charge

                    // Draw charge beam preview (where it will fire)
                    const beamLength = 2000;
                    const endX = player.x + Math.cos(player.angle) * beamLength;
                    const endY = player.y + Math.sin(player.angle) * beamLength;

                    ctx.strokeStyle = chargePercent >= 1 ? 'rgba(255, 0, 0, 0.6)' : 'rgba(255, 100, 100, 0.3)';
                    ctx.lineWidth = 8;
                    ctx.shadowBlur = 30;
                    ctx.shadowColor = '#ff0000';

                    ctx.beginPath();
                    ctx.moveTo(player.x * scaleX, player.y * scaleY);
                    ctx.lineTo(endX * scaleX, endY * scaleY);
                    ctx.stroke();
                    ctx.shadowBlur = 0;

                    // Charging bar
                    ctx.fillStyle = '#222';
                    ctx.fillRect((player.x - 20) * scaleX, (player.y - 40) * scaleY, 40 * scaleX, 6 * scaleY);

                    ctx.fillStyle = chargePercent >= 1 ? '#00ff00' : '#ff0000';
                    ctx.fillRect((player.x - 20) * scaleX, (player.y - 40) * scaleY, 40 * chargePercent * scaleX, 6 * scaleY);

                    // Text showing charging status
                    ctx.fillStyle = '#ff0000';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 3;
                    const statusText = chargePercent >= 1 ? `${player.name} READY TO FIRE!` : `${player.name} CHARGING...`;
                    ctx.strokeText(statusText, player.x * scaleX, (player.y - 50) * scaleY);
                    ctx.fillText(statusText, player.x * scaleX, (player.y - 50) * scaleY);
                }

                // Blink dash indicator
                if (player.powerup === 'blink' && player.health > 0) {
                    const now = gameState.gameTime;
                    const powerupTime = player.powerupTime || 0;
                    const powerupElapsed = now - powerupTime;

                    if (powerupElapsed < 5) {
                        const dashCooldown = now - (player.blinkCooldown || 0);
                        const canDash = dashCooldown >= 0.5;

                        ctx.fillStyle = canDash ? '#00ffff' : '#666';
                        ctx.font = 'bold 10px Arial';
                        ctx.textAlign = 'center';
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.strokeText('SPACE TO DASH', player.x * scaleX, (player.y - 40) * scaleY);
                        ctx.fillText('SPACE TO DASH', player.x * scaleX, (player.y - 40) * scaleY);
                    }
                }

                // Bouncy ball indicator
                if (player.powerup === 'bouncyball' && !player.bouncyBallUsed && player.health > 0) {
                    ctx.fillStyle = '#ffff00';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.strokeText('BOUNCY BALL READY', player.x * scaleX, (player.y - 40) * scaleY);
                    ctx.fillText('BOUNCY BALL READY', player.x * scaleX, (player.y - 40) * scaleY);
                }
            });

            updatePlayersList();
            updateMovement();

            // Continuous firing when mouse is held down
            if (isMouseDown && ws && gameState) {
                ws.send(JSON.stringify({
                    type: 'shoot',
                    angle: mouseAngle
                }));
            }

            // Draw powerup notifications ON TOP of everything
            if (gameState.powerupNotifications && gameState.powerupNotifications.length > 0) {
                gameState.powerupNotifications.forEach((notif, index) => {
                    const elapsed = gameState.gameTime - notif.time;
                    const opacity = Math.max(0, 1 - elapsed / 3); // Fade out over 3 seconds

                    const powerupNames = {
                        'machinegun': 'Machine Gun', 'ricochet': 'Ricochet Gun',
                        'speed': 'Speed Boost', 'noclip': 'No Clip',
                        'cannon': 'Cannon', 'gravity': 'Gravity Well',
                        'railgun': 'Railgun', 'blink': 'Blink Dash',
                        'bouncyball': 'Bouncy Ball'
                    };

                    const message = `${notif.playerName} got ${powerupNames[notif.powerupType] || notif.powerupType}!`;

                    ctx.save();
                    ctx.globalAlpha = opacity;
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 4;
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';

                    const y = 80 + (index * 35);
                    ctx.strokeText(message, canvas.width / 2, y);
                    ctx.fillText(message, canvas.width / 2, y);
                    ctx.restore();
                });
            }
        }

        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';

            Object.values(gameState.players).forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-info';

                const nameSpan = document.createElement('span');
                nameSpan.style.color = player.color;
                nameSpan.textContent = player.name;

                const statsSpan = document.createElement('span');
                statsSpan.style.marginLeft = '10px';
                statsSpan.style.color = '#aaa';
                statsSpan.textContent = `Kills: ${player.kills || 0} | Wins: ${player.wins || 0}`;

                const healthBar = document.createElement('div');
                healthBar.className = 'health-bar';
                const healthFill = document.createElement('div');
                healthFill.className = 'health-fill';
                healthFill.style.width = (Math.max(0, player.health) / 100) * 100 + '%';
                healthBar.appendChild(healthFill);

                playerDiv.appendChild(nameSpan);
                playerDiv.appendChild(statsSpan);
                playerDiv.appendChild(healthBar);
                playersList.appendChild(playerDiv);
            });
        }



        function gameLoop() {
            render();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>

</html>